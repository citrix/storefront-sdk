# How the API works
This topic describes the behavior of the StoreFront Web API including authentication behavior, cookies, localization specifics, release compatibility and URL discovery.
## Authentication challenge
Some Web Proxy URLs are protected and require authentication information to allow access. If the required authentication information is not present, the Web Proxy returns an empty response (HTTP status code 200) with the following HTTP header:
```CitrixWebReceiver-Authenticate: reason="TokenRequired",location="Authentication/GetAuthMethods"```
The location value in the challenge specifies a URL that the client requests (via Ajax) to determine which authentication methods are available. The challenge may contain an additional attribute `mode=Redirect`, which triggers the client to redirect to a 3rd party page instead to perform the authentication step.
Even after the user has authenticated, a challenge may be returned. For example, if the user's Web Proxy session has terminated for any reason, the `ASP.NET_SessionId cookie` is absent from the client request, or if the StoreFront credential wallet service has restarted.Therefore, the client must be prepared to respond to such an authentication challenge at any time by prompting the user to re-authenticate to the site.
## Client Name, Client Address and Device Id
When the Web Proxy communicates with certain Store Service APIs, it supplies values for client name, client address and device id. These values are required for workspace control to function correctly. It is important that the Web Proxy passes consistent data for these parameters to all Store Services that take these parameters.
Client name specifies the hostname of the client machine and device id specifies a value unique to the client device. Since a typical browser-based client has limited access to the client OS and cannot determine the hostname, the Web Proxy automatically generates a random string value to use for both client name and device id. This value is returned to the client as a persistent cookie, named CtxsDeviceId, in a successful response (HTTP status 200) to a resource enumeration. It is expected that this cookie is returned by the client in subsequent requests.
Client address identifies the client IP address. This may be used on some XenApp/ XenDesktop systems to determine if a client should be presented with a particular resource. The Web Proxy automatically determines the client address from the Microsoft ASP.NET API `HttpRequest.UserHostAddress`, which returns the IP address of the client as seen at the web server. This may not be the actual client address; for example, if connecting through a NetScaler Gateway or other proxy server.
If multiple web browsers connect to a Citrix Receiver for Web site from the same client machine, a different (random) value for the CtxsDeviceId cookie is returned to each browser to represent the client name and device id. This results in the sessions being treated by the Store Services as running on separate devices. This may lead to apps disappearing and reappearing when performing session operations; for example, querying and reconnecting to sessions.
## CookiesThe Web Proxy sets a number of cookies as outlined in the table below. The client must return the cookies in subsequent requests, as indicated by the cookie life time.
| Cookie   | Life time | HttpOnly | When Set | Description
|----------|-----------|----------|----------|-----------------------------------------------------|
| **ASP.NET_SessionId** | Session    | Yes | First response from Web Proxy | ASP.NET session id, represents the web session between client and Web Proxy.| 
| **CtxsAuthId** | Session | Yes | Response indicating successful authentication| Protects against session fixation attacks |
|**CsrfToken** | Session | No | First response from Web Proxy | Protects against cross- site request forgery attacks |
| **CtxsDeviceId** | Persistent, 2 years | Yes | Response indicating successful resource enumeration | Specifies the value to use for client name and device id (see above) |

## HTTPS indicator to secure cookiesUnless specified otherwise, the Web Proxy API requires the client to indicate whether it is using an HTTPS connection or not by supplying a header named `X-Citrix- IsUsingHTTPS` with value "Yes" or "No". When the value is set to "Yes", the Web Proxy sets the Secure attribute for all cookies that it generates to protect them from being viewed from non-HTTPS connections. This caters for NetScaler Gateway scenarios where the connection from the browser to the gateway is over HTTPS but the connection from the gateway to the internal Citrix Receiver for Web site (where the Web Proxy runs) is HTTP.##Cross-site request forgery tokenTo protect against cross-site request forgery (CSRF) attacks, the Web Proxy APIs require that a CSRF token be supplied by the client, unless specified otherwise. This is a random string generated by the Web Proxy for the duration of the session and communicated to the client using a session cookie. Clients must read the value of this cookie and send it back to the Web Proxy in most API calls, as either the value of a header named Csrf-Token (note the hyphen) for POST requests, or as the value of a query string parameter named CsrfToken for GET requests.##LocalizationGenerally, the Web Proxy does not return user-facing strings to display in a UI. However, the authentication process uses the Citrix Common Forms protocol to obtain a definition of the logon form (amongst other forms), which typically includes strings for UI controls (for example, a "Username: " label or "Log On" button). The value specified in the Accept-Language HTTP header is used to determine the language for such strings. This value is also reflected back to the client in the response to the /Home/ Configuration request so that the client may perform any additional localization to match the language used for authentication forms.##Hypermedia control and parameterized URLsThe StoreFront Web API uses the concept of hypermedia controls. With hypermedia controls, links to resources and actions are obtained from the server, either from the client configuration (/Home/Configuration) or directly as the result of calling this API. This means that clients must never construct URLs.In these topics, various parameterized URLs are discussed, such as /Resources/ Subscription/{id}. It is important to note that these are indicative only, because the client code must not construct URLs directly. Instead, all parameterized URLs must be obtained from the service itself. For example, the URL to launch a particular resource must be extracted from the JSON data returned from the request to /Resources/List/.In some cases, additional parameters can be supplied to a service that is invoked by a GET HTTP request. These parameters are supplied to the service by adding query string parameters to the base service URL. Clients must not make assumptions on the form of the service URL, which may vary with different releases. In particular, clients must not make assumptions about the presence or absence of query string parameters in the base service URL and must determine in each case whether new parameters should be appended with '?' or '&'.##Backwards and forwards compatibilityThis is a preliminary revision of the Web Proxy API. No guarantees are made about backwards or forwards compatibility with any previous or future releases of Citrix Receiver for Web.##URL discoveryWhen the JavaScript code executes in the browser, it first makes an Ajax request to the Web Proxy URL defined by the variable CTXS.configUrl (this defaults to /Home/ Configuration, but can be overridden by a JavaScript customization). This returns an XML document describing various Citrix Receiver for Web configuration settings, including a number of URL paths (relative to the site root) that the client must use for subsequent API calls. In addition to these "fixed" URLs, the client may later be sent additional URL paths specific to a given resource. For example, calling Resource/List returns JSON data describing all resources available to the user, including URL paths (per resource) for resource-specific operations such as launching a given resource or subscribing to a resource. These URL paths contain a resource id embedded within them.##API usage patternAt a high level, the client accesses the Web Proxy API by performing calls in the following order:
1. Fetch the site configuration, to determine behavior and discover URLs for subsequent operations2. Perform authentication, to allow access to resources3. List sessions, to perform auto session reconnect at logon4. List resources, to fetch additional (per-resource) URLs for launch and subscription operations5. Launch and subscribe to resources in response to user actions in the UI##HTTP POST ParametersThroughout the API, any request parameters in the POST body must follow standard form URL-encoding rules, with Content-Type set to:
```
application/x-www-form-urlencoded
```

